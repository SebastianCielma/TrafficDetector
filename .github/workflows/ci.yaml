name: CI/CD Pipeline

on:
  push:
    branches: [ "main", "master" ]
  pull_request:
    branches: [ "main", "master" ]

env:
  GCP_REGION: europe-west1
  GCP_REPO_NAME: traffic-repo
  GCP_IMAGE_NAME: traffic-app

jobs:
  test:
    name: üß™ Run Tests & Quality Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v3
        with:
          version: "latest"
          enable-cache: true

      - name: Set up Python 3.12
        run: uv python install 3.12

      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libgl1

      - name: Install dependencies
        run: uv sync --all-extras --dev

      - name: Run Ruff (Lint)
        run: |
          uv run ruff check .
          uv run ruff format --check .

      - name: Run Pyright (Types)
        run: uv run pyright

      - name: Run Tests (Pytest)
        env:
          PROJECT_NAME: "TrafficDetectorCI"
          MODEL_PATH: "yolov8n.pt"
          API_URL: "http://localhost:8000"
          DATABASE_URL: "postgresql+asyncpg://user:pass@localhost:5432/test_db"
          S3_BUCKET_NAME: "ci-test-bucket"
          S3_ENDPOINT: "https://fake-endpoint.cloudflare.com"
          S3_ACCESS_KEY: "fake-access-key"
          S3_SECRET_KEY: "fake-secret-key"
          TRAFFIC_BUCKET_NAME: "ci-test-bucket"
          TRAFFIC_ENDPOINT: "https://fake-endpoint.cloudflare.com"
          TRAFFIC_ACCESS_KEY: "fake-access-key"
          TRAFFIC_SECRET_KEY: "fake-secret-key"
          CELERY_BROKER_URL: "redis://fake-redis:6379/0"
          CELERY_RESULT_BACKEND: "redis://fake-redis:6379/0"
          API_KEY: "ci-secret-key"
          UI_USERNAME: "ci-user"
          UI_PASSWORD: "ci-password"
        run: uv run pytest -v

  security:
    name: üõ°Ô∏è Security Scan (Trivy)
    runs-on: ubuntu-latest
    needs: test

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Build Docker Image (for scanning)
        run: docker build -t traffic-app:${{ github.sha }} .

      - name: Run Trivy Vulnerability Scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'traffic-app:${{ github.sha }}'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'

  deploy-gcp:
    name: Deploy to Google Cloud Run
    needs: [test, security]
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Auth to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WIF_PROVIDER }}
          service_account: ${{ secrets.GCP_SA_EMAIL }}

      - name: Configure Docker
        run: gcloud auth configure-docker ${{ env.GCP_REGION }}-docker.pkg.dev

      - name: Build and Push Docker Image
        env:
          IMAGE_TAG: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.GCP_REPO_NAME }}/${{ env.GCP_IMAGE_NAME }}:${{ github.sha }}
        run: |
          docker build -t $IMAGE_TAG .
          docker push $IMAGE_TAG

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: traffic-api
          region: ${{ env.GCP_REGION }}
          image: ${{ env.GCP_REGION }}-docker.pkg.dev/${{ secrets.GCP_PROJECT_ID }}/${{ env.GCP_REPO_NAME }}/${{ env.GCP_IMAGE_NAME }}:${{ github.sha }}

          env_vars: |
            DATABASE_URL=${{ secrets.DATABASE_URL }}
            CELERY_BROKER_URL=${{ secrets.CELERY_BROKER_URL }}
            S3_BUCKET_NAME=${{ secrets.S3_BUCKET_NAME }}
            S3_ENDPOINT=${{ secrets.S3_ENDPOINT }}
            S3_ACCESS_KEY=${{ secrets.S3_ACCESS_KEY }}
            S3_SECRET_KEY=${{ secrets.S3_SECRET_KEY }}
            LOKI_URL=${{ secrets.LOKI_URL }}
            LOKI_USERNAME=${{ secrets.LOKI_USERNAME }}
            LOKI_PASSWORD=${{ secrets.LOKI_PASSWORD }}
            ENVIRONMENT=production
            API_KEY=${{ secrets.API.KEY }}
            UI_USERNAME=${{ secrets.UI_USERNAME }}
            UI_PASSWORD=${{ secrets.UI_PASSWORD }}

          flags: '--allow-unauthenticated --port=7860 --memory=2Gi --cpu=1'
